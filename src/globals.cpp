#include "rev.h"
#include "hash.h"

// global variable definition
__attribute__ ((aligned (32)))board b_m;    // master board. Align to at least 32, for AVX2 operations.

hashtype * h;                               // main TT
unsigned int MPCmult;                       // MPC mult
unsigned int MIN_ENDCUT_DEPTH;			    // depth for switch to "_e" functions
TimePoint t_break;                          // time when search has to end
unsigned int TTage;                         // age of TT table
unsigned int break_ind;                     // timeout break indicator

// conversion/translation arrays; put them into large page RAM.
unsigned int *c2to3;        // converts power of 2 to power of 3. Up to 10 bits
unsigned int *tr_ar_c9;     // converts 3 c9 patterns. Up to 9 bits each.
unsigned int *tr_ar_c10;    // converts 7 c10 patterns. Up to 10 bits each.

// eval coeffs
eval_type *mob1_c, *mob2_c, *s8a_c, *s8b_c, *s8c_c, *s8d_c, *d8_c, *d7_c, *d6_c, *d5_c, *d4_c, *c8_c, *c9_c;
float __attribute__ ((aligned (32))) n_c[49][EVAL_WIDTH]; // 6 Kb

// sigma coeffs
eval_type __attribute__ ((aligned (32))) n_c2[41][16];
eval_type __attribute__ ((aligned (32))) mob1_c2[22][16];
eval_type __attribute__ ((aligned (32))) mob2_c2[22][16];
eval_type __attribute__ ((aligned (32))) s8a_c2[81*81][16];
eval_type __attribute__ ((aligned (32))) s8b_c2[81*81][16];
eval_type __attribute__ ((aligned (32))) s8c_c2[81*81][16];
eval_type __attribute__ ((aligned (32))) s8d_c2[81*81][16];
eval_type __attribute__ ((aligned (32))) c9_c2[81*81*3][16];
eval_type __attribute__ ((aligned (32))) c10_c2[81*81*9][16];
float __attribute__ ((aligned (32))) d_c2[18][16];

// cut depths. Here i set it to 0 for 36+, so that "sigmas" are never accessed for first index > 31.
int cut_depth[] = {-1,-1, 0, 1, 2, 1, 2, 3, 4, 3, 4, 3, 4, 5, 4, 5, 4, 5, 6, 7, 8, 7, 8, 7, 8, 7, 8, 7, 8, 7, 8, 7, 8, 7, 8, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1};
    //from:         0  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34  35  36  37  38  39  40  41  42  43  44  45  46  47  48  49  50  51  52  53  54
    // save:        0  0  0  2  2  4  4  4  4  6  6  8  8  8 10 10 12 12 12 12 12 14 14	16 16 18 18 20 20 22 22 24 24 26 26

// n = 4 to 63. Start at curr_depth = 2
unsigned int sigmas[33][64] = {
0,0,0,0,0,0, 50, 50, 50, 50, 50, 50, 50, 50, 50, 52, 54, 55, 59, 58, 60, 62, 64, 65, 66, 67, 69, 70, 72, 73, 75, 74, 77, 76, 79, 78, 81, 81, 83, 83, 85, 84, 86, 86, 88, 89, 90, 90, 91, 91, 92, 91, 91, 90, 89, 0, 0,0,0,0,0,0,0,0,//2
0,0,0,0,0,0, 43, 43, 43, 43, 43, 43, 43, 43, 43, 45, 45, 49, 47, 49, 50, 51, 52, 52, 53, 54, 55, 56, 56, 58, 58, 59, 59, 61, 61, 62, 63, 64, 65, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 74, 74, 75, 75, 75, 0, 0, 0,0,0,0,0,0,0,0,//3
0,0,0,0,0,0, 37, 37, 37, 37, 37, 37, 37, 38, 39, 39, 41, 40, 41, 42, 43, 44, 46, 47, 47, 48, 49, 49, 50, 50, 52, 52, 53, 53, 55, 55, 56, 57, 58, 58, 59, 59, 61, 61, 63, 64, 65, 66, 67, 67, 68, 68, 69, 0, 0, 0, 95,0,0,0,0,0,0,0,//4
0,0,0,0,0,0, 53, 53, 53, 53, 53, 53, 53, 53, 53, 55, 56, 59, 59, 60, 61, 63, 64, 65, 66, 67, 68, 69, 70, 72, 73, 74, 75, 76, 77, 78, 79, 79, 81, 81, 82, 83, 84, 86, 87, 89, 90, 93, 93, 95, 95, 96, 0, 0, 0, 98, 0,0,0,0,0,0,0,0,//5
0,0,0,0,0,0, 46, 46, 46, 46, 46, 46, 46, 46, 47, 48, 50, 51, 52, 53, 53, 56, 57, 58, 59, 60, 61, 61, 63, 63, 64, 65, 66, 66, 68, 68, 70, 71, 72, 72, 74, 75, 76, 77, 79, 80, 82, 83, 86, 87, 88, 0, 0, 0, 95, 0, 0,0,0,0,0,0,0,0,//6
0,0,0,0,0,0, 42, 42, 42, 42, 42, 42, 42, 45, 45, 47, 47, 48, 48, 49, 50, 51, 52, 53, 53, 54, 55, 57, 57, 58, 59, 60, 61, 62, 63, 63, 64, 65, 67, 67, 70, 70, 72, 73, 74, 76, 78, 79, 82, 83, 0, 0, 0, 95, 0, 0, 0,0,0,0,0,0,0,0,//7
0,0,0,0,0,0, 42, 42, 42, 42, 42, 42, 42, 42, 43, 43, 44, 45, 45, 48, 48, 49, 50, 50, 52, 52, 53, 53, 55, 55, 56, 58, 59, 59, 60, 61, 62, 63, 64, 64, 66, 67, 69, 70, 72, 73, 75, 76, 77, 0, 0, 0, 95, 0, 0, 0, 0,0,0,0,0,0,0,0,//8
0,0,0,0,0,0, 47, 47, 47, 47, 47, 47, 47, 48, 48, 52, 52, 53, 53, 54, 55, 56, 57, 59, 60, 61, 62, 63, 63, 65, 65, 66, 68, 69, 70, 71, 72, 73, 74, 75, 78, 79, 80, 81, 83, 86, 88, 89, 0, 0, 0, 110, 0, 0, 0, 0, 0,0,0,0,0,0,0,0,//9
0,0,0,0,0,0, 46, 46, 46, 46, 46, 46, 46, 47, 48, 48, 49, 50, 51, 53, 54, 54, 55, 56, 57, 58, 60, 60, 62, 62, 63, 63, 65, 65, 66, 68, 69, 70, 71, 72, 74, 74, 77, 78, 80, 82, 84, 0, 0, 0, 108, 0, 0, 0, 0, 0, 0,0,0,0,0,0,0,0,//10
0,0,0,0,0,0, 51, 51, 51, 51, 51, 51, 51, 52, 52, 56, 55, 57, 57, 58, 59, 61, 62, 64, 64, 66, 66, 69, 69, 70, 71, 72, 73, 74, 76, 77, 78, 79, 80, 81, 83, 85, 86, 88, 90, 92, 0, 0, 0, 120, 0, 0, 0, 0, 0, 0, 0,0,0,0,0,0,0,0,//11
0,0,0,0,0,0, 50, 50, 50, 50, 50, 50, 50, 50, 51, 52, 53, 54, 54, 56, 57, 58, 60, 60, 62, 63, 64, 64, 66, 66, 67, 69, 70, 70, 72, 72, 75, 76, 77, 78, 80, 80, 83, 84, 86, 0, 0, 0, 117, 0, 0, 0, 0, 0, 0, 0, 0,0,0,0,0,0,0,0,//12
0,0,0,0,0,0, 47, 47, 47, 47, 47, 47, 47, 49, 48, 51, 51, 52, 53, 54, 55, 57, 57, 58, 59, 60, 60, 63, 63, 64, 64, 65, 66, 67, 69, 70, 71, 73, 75, 76, 77, 78, 79, 82, 0, 0, 0, 114, 0, 0, 0, 0, 0, 0, 0, 0, 0,0,0,0,0,0,0,0,//13
0,0,0,0,0,0, 53, 53, 53, 53, 53, 53, 53, 53, 54, 54, 56, 58, 59, 60, 61, 62, 64, 65, 66, 67, 69, 69, 70, 71, 72, 72, 75, 75, 77, 77, 80, 80, 82, 82, 84, 86, 88, 0, 0, 0, 121, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0,0,0,0,0,0,0,//14
0,0,0,0,0,0, 50, 50, 50, 50, 50, 50, 50, 52, 52, 54, 54, 55, 56, 57, 59, 60, 61, 62, 63, 65, 65, 66, 66, 68, 68, 70, 71, 72, 73, 75, 76, 78, 78, 80, 82, 83, 0, 0, 0, 116, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0,0,0,0,0,0,0,//15
0,0,0,0,0,0, 56, 56, 56, 56, 56, 56, 56, 56, 57, 57, 60, 61, 61, 63, 65, 66, 67, 68, 70, 71, 72, 72, 73, 75, 76, 76, 79, 79, 81, 81, 84, 85, 86, 87, 90, 0, 0, 0, 121, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0,0,0,0,0,0,0,//16
0,0,0,0,0,0, 53, 53, 53, 53, 53, 53, 53, 55, 55, 57, 57, 58, 59, 61, 62, 63, 64, 66, 67, 68, 68, 70, 71, 72, 72, 73, 75, 77, 77, 79, 80, 82, 84, 85, 0, 0, 0, 118, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0,0,0,0,0,0,0,//17
0,0,0,0,0,0, 52, 52, 52, 52, 52, 52, 52, 54, 55, 55, 56, 58, 59, 60, 62, 63, 64, 64, 65, 67, 68, 68, 69, 71, 72, 72, 75, 75, 77, 77, 80, 80, 83, 0, 0, 0, 117, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0,0,0,0,0,0,0,//18
0,0,0,0,0,0, 51, 51, 51, 51, 51, 51, 51, 53, 53, 55, 55, 56, 59, 59, 60, 61, 61, 64, 64, 65, 67, 68, 68, 69, 71, 72, 72, 75, 76, 76, 77, 80, 0, 0, 0, 113, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0,0,0,0,0,0,0,//19
0,0,0,0,0,0, 53, 53, 53, 53, 53, 53, 53, 53, 54, 54, 56, 57, 59, 60, 60, 61, 63, 63, 66, 66, 67, 67, 70, 70, 71, 71, 74, 74, 77, 77, 79, 0, 0, 0, 114, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0,0,0,0,0,0,0,//20
0,0,0,0,0,0, 56, 56, 56, 56, 56, 56, 56, 59, 59, 60, 60, 61, 64, 64, 66, 67, 67, 70, 70, 72, 73, 75, 75, 76, 78, 79, 79, 82, 83, 83, 0, 0, 0, 113, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0,0,0,0,0,0,0,//21
0,0,0,0,0,0, 59, 59, 59, 59, 59, 59, 59, 59, 60, 60, 62, 63, 65, 66, 66, 68, 69, 69, 72, 72, 74, 74, 77, 77, 79, 79, 82, 82, 85, 0, 0, 0, 113, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0,0,0,0,0,0,0,//22
0,0,0,0,0,0, 62, 62, 62, 62, 62, 62, 62, 65, 65, 67, 67, 68, 72, 72, 73, 75, 75, 78, 78, 80, 81, 83, 83, 85, 86, 88, 88, 91, 0, 0, 0, 112, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0,0,0,0,0,0,0,//23
0,0,0,0,0,0, 66, 66, 66, 66, 66, 66, 66, 66, 67, 67, 69, 71, 72, 74, 74, 76, 78, 78, 81, 81, 83, 83, 86, 86, 88, 88, 91, 0, 0, 0, 114, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0,0,0,0,0,0,0,//24
0,0,0,0,0,0, 70, 70, 70, 70, 70, 70, 70, 73, 73, 75, 75, 77, 81, 81, 82, 84, 84, 88, 88, 90, 92, 93, 93, 95, 97, 99, 0, 0, 0, 113, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0,0,0,0,0,0,0,//25
0,0,0,0,0,0, 74, 74, 74, 74, 74, 74, 74, 74, 76, 76, 78, 80, 82, 84, 84, 86, 88, 88, 92, 92, 94, 94, 98, 98, 99, 0, 0, 0, 115, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0,0,0,0,0,0,0,//26
0,0,0,0,0,0, 79, 79, 79, 79, 79, 79, 79, 83, 83, 85, 85, 87, 92, 92, 94, 96, 96, 100, 100, 102, 104, 106, 106, 108, 0, 0, 0, 115, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0,0,0,0,0,0,0,//27
0,0,0,0,0,0, 85, 85, 85, 85, 85, 85, 85, 85, 87, 87, 89, 91, 94, 96, 96, 98, 100, 100, 105, 105, 107, 107, 112, 0, 0, 0, 116, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0,0,0,0,0,0,0,//28
0,0,0,0,0,0, 93, 93, 93, 93, 93, 93, 93, 98, 98, 101, 101, 103, 108, 108, 110, 113, 113, 118, 118, 120, 123, 125, 0, 0, 0, 125, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0,0,0,0,0,0,0,//29
0,0,0,0,0,0, 103, 103, 103, 103, 103, 103, 103, 103, 105, 105, 108, 111, 113, 116, 116, 119, 121, 121, 127, 127, 130, 0, 0, 0, 136, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0,0,0,0,0,0,0,//30
0,0,0,0,0,0, 113, 113, 113, 113, 113, 113, 113, 119, 119, 122, 122, 125, 131, 131, 134, 137, 137, 143, 143, 145, 0, 0, 0, 147, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0,0,0,0,0,0,0,//31
0,0,0,0,0,0, 124, 124, 124, 124, 124, 124, 124, 124, 127, 127, 131, 134, 137, 140, 140, 144, 147, 147, 153, 0, 0, 0, 160, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0,0,0,0,0,0,0,//32
0,0,0,0,0,0, 137, 137, 137, 137, 137, 137, 137, 144, 144, 147, 147, 151, 158, 158, 162, 165, 165, 172, 0, 0, 0, 170, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0,0,0,0,0,0,0,//33
0,0,0,0,0,0, 150, 150, 150, 150, 150, 150, 150, 150, 154, 154, 158, 162, 166, 170, 170, 174, 178, 0, 0, 0, 185, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0,0,0,0,0,0,0,//34
};
//456 7 8 9  10  11  12  13  14  15  16  17  18  19  20  21  22  23  24  25  26  27  28  29  30  31  32  33  34  35  36  37  38  39  40  41  42  43  44  45  46  47  48  49  50  51  52  53  54  55  56  57  58  59  60   616263 fillers, for 64 total size
// 0 to 64
